openapi: 3.0.3
info:
  title: Watch Tower API
  description: REST API for reading data from Watch Tower database. All endpoints are read-only.
  version: 1.0.0
  contact:
    name: Watch Tower API Support

servers:
  - url: /api.php
    description: API Server

paths:
  /programs:
    get:
      summary: Get all programs
      description: Retrieve a list of all programs from the database
      operationId: getPrograms
      tags:
        - Programs
      parameters:
        - name: json
          in: query
          description: Response format (true for JSON, false for plain text)
          required: false
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  programs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Program'
            text/plain:
              schema:
                type: string
                example: "program1\nprogram2\nprogram3"

  /programs/{programName}:
    get:
      summary: Get program by name
      description: Retrieve a specific program by its name
      operationId: getProgramByName
      tags:
        - Programs
      parameters:
        - name: programName
          in: path
          required: true
          description: The name of the program
          schema:
            type: string
        - name: json
          in: query
          description: Response format (true for JSON, false for plain text)
          required: false
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Program found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Program'
        '404':
          description: Program not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /subdomains:
    get:
      summary: Get all subdomains
      description: Retrieve all subdomains from the database, optionally filtered by program name
      operationId: getSubdomains
      tags:
        - Subdomains
      parameters:
        - name: program_name
          in: query
          description: Filter subdomains by program name
          required: false
          schema:
            type: string
        - name: domain
          in: query
          description: Filter subdomains by domain (uses LIKE search)
          required: false
          schema:
            type: string
        - name: json
          in: query
          description: Response format (true for JSON, false for plain text)
          required: false
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  subdomains:
                    type: array
                    items:
                      $ref: '#/components/schemas/Subdomain'
            text/plain:
              schema:
                type: string
                example: "subdomain1.example.com\nsubdomain2.example.com"

  /http:
    get:
      summary: Get HTTP services
      description: Retrieve HTTP service information from the database, optionally filtered by program name
      operationId: getHttpServices
      tags:
        - HTTP Services
      parameters:
        - name: program_name
          in: query
          description: Filter HTTP services by program name
          required: false
          schema:
            type: string
        - name: domain
          in: query
          description: Filter HTTP services by domain (uses LIKE search)
          required: false
          schema:
            type: string
        - name: json
          in: query
          description: Response format (true for JSON, false for plain text)
          required: false
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  http:
                    type: array
                    items:
                      $ref: '#/components/schemas/HttpService'
            text/plain:
              schema:
                type: string
                example: "subdomain1.example.com\nsubdomain2.example.com"

  /live-subdomains:
    get:
      summary: Get live subdomains
      description: Retrieve live subdomains from the database, optionally filtered by program name
      operationId: getLiveSubdomains
      tags:
        - Live Subdomains
      parameters:
        - name: program_name
          in: query
          description: Filter live subdomains by program name
          required: false
          schema:
            type: string
        - name: domain
          in: query
          description: Filter live subdomains by domain (uses LIKE search)
          required: false
          schema:
            type: string
        - name: json
          in: query
          description: Response format (true for JSON, false for plain text)
          required: false
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  live_subdomains:
                    type: array
                    items:
                      $ref: '#/components/schemas/LiveSubdomain'
            text/plain:
              schema:
                type: string
                example: "subdomain1.example.com\nsubdomain2.example.com"

  /all:
    get:
      summary: Get all programs and subdomains
      description: Retrieve all programs and subdomains together in a single response
      operationId: getAll
      tags:
        - Combined
      parameters:
        - name: json
          in: query
          description: Response format (true for JSON, false for plain text)
          required: false
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  programs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Program'
                  subdomains:
                    type: array
                    items:
                      $ref: '#/components/schemas/Subdomain'
            text/plain:
              schema:
                type: string
                example: "=== PROGRAMS ===\nprogram1\nprogram2\n\n=== SUBDOMAINS ===\nsubdomain1.example.com\nsubdomain2.example.com"

  /port-scanner:
    get:
      summary: Port scanner lookup
      description: Retrieve open port details for a specific domain or list domains with open ports for a program
      operationId: getPortScannerResults
      tags:
        - Ports
      parameters:
        - name: domain
          in: query
          description: Return open ports for this exact domain (subdomain)
          required: false
          schema:
            type: string
        - name: program_name
          in: query
          description: Return domains and ports associated with this program
          required: false
          schema:
            type: string
        - name: json
          in: query
          description: Response format (true for JSON, false for plain text)
          required: false
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/PortScannerDomain'
                  - type: object
                    properties:
                      program_name:
                        type: string
                        description: Program the domains belong to
                      domains:
                        type: array
                        items:
                          $ref: '#/components/schemas/PortScannerDomain'
            text/plain:
              schema:
                type: string
                example: "example.com: 80, 443"
        '400':
          description: Missing filter parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Domain not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    Program:
      type: object
      properties:
        id:
          type: integer
          description: Program ID
        program_name:
          type: string
          description: Name of the program
        created_date:
          type: string
          format: date-time
          description: Creation timestamp
        config:
          type: object
          description: Program configuration (JSONB)
          additionalProperties: true
        scopes:
          type: array
          description: Program scopes
          items:
            type: string
        ooscopes:
          type: array
          description: Out of scope items
          items:
            type: string

    Subdomain:
      type: object
      properties:
        id:
          type: integer
          description: Subdomain ID
        program_name:
          type: string
          description: Associated program name
        subdomain:
          type: string
          description: Subdomain name
        scope:
          type: string
          description: Scope information
        provider:
          type: string
          description: Provider information
        created_date:
          type: string
          format: date-time
          description: Creation timestamp
        last_update:
          type: string
          format: date-time
          description: Last update timestamp

    HttpService:
      type: object
      properties:
        id:
          type: integer
          description: HTTP service ID
        program_name:
          type: string
          description: Associated program name
        subdomain:
          type: string
          description: Subdomain name
        scope:
          type: string
          description: Scope information
        ips:
          type: array
          description: IP addresses
          items:
            type: string
        tech:
          type: array
          description: Technologies detected
          items:
            type: string
        title:
          type: string
          description: Page title
        status_code:
          type: string
          description: HTTP status code
        headers:
          type: object
          description: HTTP headers (JSONB)
          additionalProperties: true
        url:
          type: string
          description: URL
        final_url:
          type: string
          description: Final redirect URL
        favicon:
          type: string
          description: Favicon URL
        created_date:
          type: string
          format: date-time
          description: Creation timestamp
        last_update:
          type: string
          format: date-time
          description: Last update timestamp

    LiveSubdomain:
      type: object
      properties:
        id:
          type: integer
          description: Live subdomain ID
        program_name:
          type: string
          description: Associated program name
        subdomain:
          type: string
          description: Subdomain name
        scope:
          type: string
          description: Scope information
        ips:
          type: array
          description: IP addresses
          items:
            type: string
        cdn:
          type: object
          description: CDN information (JSONB)
          additionalProperties: true
        created_date:
          type: string
          format: date-time
          description: Creation timestamp
        last_update:
          type: string
          format: date-time
          description: Last update timestamp

    PortScannerDomain:
      type: object
      properties:
        subdomain:
          type: string
          description: Domain or subdomain that has open ports
        ports:
          type: array
          items:
            $ref: '#/components/schemas/PortScannerPort'

    PortScannerPort:
      type: object
      properties:
        port:
          type: integer
          description: Open port number
        protocol:
          type: string
          description: Protocol detected on the port
        service:
          type: string
          description: Service associated with the port
        program_name:
          type: string
          description: Program associated with the port (present when querying by domain)
        last_update:
          type: string
          format: date-time
          description: Last time the port information was updated

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
        code:
          type: integer
          description: HTTP status code

